<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SL Ruttkarta</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: system-ui, sans-serif;
}

header {
  background: #0d6efd;
  padding: 0.5rem;
}

header form {
  display: flex;
  gap: 0.5rem;
}

header input {
  flex: 1;
  border-radius: 8px;
  border: none;
  padding: 0.6rem;
  font-size: 1rem;
}

header button {
  border: none;
  border-radius: 8px;
  padding: 0.6rem 1rem;
  font-size: 1rem;
  background: white;
  color: #0d6efd;
  font-weight: 600;
}

header button:disabled {
  opacity: 0.6;
  cursor: wait;
}

#statusMsg {
  display: none;
  padding: 0.5rem;
  text-align: center;
  background: #fff3cd;
  color: #664d03;
  font-size: 0.9rem;
}

#map {
  height: calc(100% - 56px);
}

@media (max-width: 480px) {
  header form {
    flex-direction: column;
  }
  header button {
    width: 100%;
  }
}
</style>
</head>

<body>

<header>
  <form id="lineForm">
    <input
      id="lineInput"
      placeholder="Linje (t.ex. 117)"
      inputmode="numeric"
      pattern="[0-9]*"
      autocomplete="off"
    />
    <button type="submit" id="submitBtn">Visa</button>
  </form>
</header>

<div id="statusMsg">
  ⏳ Startar servern… detta kan ta några sekunder första gången
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const API_BASE = "https://sl-realtime-backend-clean.onrender.com";
const statusMsg = document.getElementById("statusMsg");

// =====================================================
// KARTA
// =====================================================
const map = L.map("map").setView([59.33, 18.07], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const routeLayer   = L.layerGroup().addTo(map);
const stopLayer    = L.layerGroup().addTo(map);
const vehicleLayer = L.layerGroup().addTo(map);

let vehicleInterval = null;

// =====================================================
// TRAFIKSLAGSLOGIK
// =====================================================
function getTrafficMode(routeType) {
  const rt = Number(routeType);
  if ([401, 402, 405].includes(rt)) return "metro";
  if (rt === 900) return "tram";
  if (rt === 100) return "train";
  if (rt === 700) return "bus";
  if (rt === 1000) return "boat";
  return "bus";
}

// =====================================================
// SVG-IKONER
// =====================================================
function svgIcon(svg, size = 36) {
  return L.divIcon({
    className: "",
    iconSize: [size, size],
    iconAnchor: [size / 2, size / 2],
    html: svg
  });
}

function getIconForRouteType(routeType) {
  const mode = getTrafficMode(routeType);
  switch (mode) {
    case "metro":
      return svgIcon(`<svg viewBox="0 0 64 64" width="36" height="36">
        <path d="M16 52h6l4-8h12l4 8h6V20c0-6-6-10-16-10s-16 4-16 10v32z"
              fill="#007b3d"/>
        <rect x="22" y="22" width="20" height="10" fill="#e6f5ec"/>
      </svg>`);
    case "tram":
      return svgIcon(`<svg viewBox="0 0 64 64" width="36" height="36">
        <rect x="14" y="18" width="36" height="26" rx="4" fill="#8b0000"/>
        <rect x="18" y="22" width="28" height="10" fill="#f2dede"/>
        <circle cx="22" cy="48" r="3"/>
        <circle cx="42" cy="48" r="3"/>
      </svg>`);
    case "train":
      return svgIcon(`<svg viewBox="0 0 64 64" width="36" height="36">
        <rect x="18" y="14" width="28" height="34" rx="6" fill="#333"/>
        <rect x="22" y="18" width="20" height="12" fill="#ddd"/>
      </svg>`);
    case "boat":
      return svgIcon(`<svg viewBox="0 0 64 64" width="36" height="36">
        <path d="M10 34h44l-6 12H16z" fill="#0057b8"/>
        <rect x="24" y="20" width="16" height="10" rx="2" fill="#333"/>
      </svg>`);
    default:
      return svgIcon(`<svg viewBox="0 0 64 64" width="36" height="36">
        <rect x="14" y="18" width="36" height="26" rx="6" fill="#c1121f"/>
        <rect x="18" y="22" width="28" height="10" fill="#f8d7da"/>
      </svg>`);
  }
}

// =====================================================
// LIVE-FORDON
// =====================================================
async function updateVehicles(line, stopData) {
  try {
    const res = await fetch(`${API_BASE}/api/vehicles/${line}`);
    const vehicles = await res.json();

    vehicleLayer.clearLayers();
    if (!Array.isArray(vehicles)) return;

    vehicles.forEach(v => {
      const marker = L.marker([v.lat, v.lon], {
        icon: getIconForRouteType(v.routeType),
        rotationAngle: v.bearing
      }).addTo(vehicleLayer);

      // Visa linje, destination + avgång/ankomst för nästa hållplats
      let nextStopInfo = "";
      if (stopData && stopData.length) {
        const nextStop = stopData.find(s => s.name === v.destination);
        if (nextStop) {
          nextStopInfo = `<br>Avgång: ${nextStop.departure_time}<br>Ankomst: ${nextStop.arrival_time}`;
        }
      }

      marker.bindPopup(`
        <b>Linje: ${line}</b><br>
        Mot: ${v.destination}
      `);
    });

  } catch (err) {
    console.error("Fordon-fel:", err);
  }
}

// =====================================================
// FORM
// =====================================================
document.getElementById("lineForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const btn   = document.getElementById("submitBtn");
  const input = document.getElementById("lineInput");
  const line  = input.value.trim();
  if (!line) return;

  statusMsg.style.display = "block";
  btn.disabled = true;
  btn.textContent = "⏳ Laddar...";
  routeLayer.clearLayers();
  stopLayer.clearLayers();
  vehicleLayer.clearLayers();

  try {
    const res = await fetch(`${API_BASE}/api/line/${line}`);
    const data = await res.json();

    // Rita rutten
    L.polyline(data.shape, { color: "#0d6efd", weight: 5 }).addTo(routeLayer);

    // Rita hållplatser och bind popup med namn + tider
    data.stops.forEach(s => {
      L.circleMarker([s.lat, s.lon], {
        radius: 5,
        color: "#0d6efd",
        fillColor: "#fff",
        fillOpacity: 1
      }).addTo(stopLayer)
        .bindPopup(`
          <b>${s.name}</b>`);
    });

    map.fitBounds(data.shape, { padding: [40, 40] });

    // Uppdatera fordon
    updateVehicles(line, data.stops);
    clearInterval(vehicleInterval);
    vehicleInterval = setInterval(() => updateVehicles(line, data.stops), 5000);

  } catch {
    alert("Linjen finns inte eller data om linjen saknas!");
  } finally {
    btn.disabled = false;
    btn.textContent = "Visa";
    statusMsg.style.display = "none";
  }
});

document.getElementById("lineInput").focus();
</script>

</body>
</html>
